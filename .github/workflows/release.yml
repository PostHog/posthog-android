name: 'Release'

permissions:
    contents: read

on:
    pull_request:
        types: [closed]
        branches: [main]
    workflow_dispatch:

# Concurrency control: only one release process can run at a time
# This prevents race conditions if multiple PRs with 'release' label merge simultaneously
concurrency:
    group: release
    cancel-in-progress: false

jobs:
    check-changesets:
        name: Check for changesets
        runs-on: ubuntu-latest
        # Run when PR with 'release' label is merged to main, or when manually triggered
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'pull_request'
             && github.event.pull_request.merged == true
             && contains(github.event.pull_request.labels.*.name, 'release'))
        outputs:
            has-changesets: ${{ steps.check.outputs.has-changesets }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Check for changesets
              id: check
              run: |
                  if [ ! -d ".changeset" ] || [ -z "$(ls -A .changeset/*.md 2>/dev/null | grep -v README.md)" ]; then
                    echo "‚ùå No changesets found. Cannot proceed with release."
                    echo "Please ensure your PR includes a changeset file."
                    echo "has-changesets=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "‚úì Found changesets to process"
                    echo "has-changesets=true" >> "$GITHUB_OUTPUT"
                  fi

    notify-approval-needed:
        name: Notify Slack - Approval Needed
        needs: check-changesets
        if: needs.check-changesets.outputs.has-changesets == 'true'
        uses: PostHog/.github/.github/workflows/notify-approval-needed.yml@main
        with:
            slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
            slack_user_group_id: ${{ vars.GROUP_CLIENT_LIBRARIES_SLACK_GROUP_ID }}
        secrets:
            slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
            posthog_project_api_key: ${{ secrets.POSTHOG_PROJECT_API_KEY }}

    version-bump:
        name: Bump versions and commit to main
        needs: [check-changesets, notify-approval-needed]
        runs-on: ubuntu-latest
        if: always() && needs.check-changesets.outputs.has-changesets == 'true'
        environment: 'Release'
        permissions:
            contents: write
        outputs:
            committed: ${{ steps.commit-version-bump.outputs.committed }}
        steps:
            - name: Notify Slack - Approved
              continue-on-error: true
              uses: PostHog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: '‚úÖ Release approved! Version bump in progress...'
                  emoji_reaction: 'white_check_mark'

            - name: Get GitHub App token
              id: releaser
              uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
              with:
                  app-id: ${{ secrets.GH_APP_POSTHOG_ANDROID_RELEASER_APP_ID }}
                  private-key: ${{ secrets.GH_APP_POSTHOG_ANDROID_RELEASER_PRIVATE_KEY }}

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0
                  token: ${{ steps.releaser.outputs.token }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Setup environment
              uses: ./.github/actions/setup

            - name: Update versions and changelogs
              run: pnpm changeset version

            - name: Commit version bump
              id: commit-version-bump
              run: |
                  git add -A
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                    echo "committed=false" >> "$GITHUB_OUTPUT"
                  else
                    git commit -m "chore: update versions and changelogs [version bump]"
                    git push origin main
                    echo "committed=true" >> "$GITHUB_OUTPUT"
                  fi
              env:
                  GITHUB_TOKEN: ${{ steps.releaser.outputs.token }}

    notify-rejected:
        name: Notify Slack - Rejected
        needs: [version-bump, notify-approval-needed]
        runs-on: ubuntu-latest
        if: always() && needs.version-bump.result == 'failure' && needs.notify-approval-needed.outputs.slack_ts != ''
        steps:
            - name: Check for rejection
              id: check-rejection
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  RESPONSE=$(gh api /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/approvals)
                  REJECTED=$(echo "$RESPONSE" | jq '[.[] | select(.state == "rejected")] | length')
                  if [ "$REJECTED" -gt 0 ]; then
                    echo "was_rejected=true" >> "$GITHUB_OUTPUT"
                    COMMENT=$(echo "$RESPONSE" | jq -r '.[] | select(.state == "rejected") | .comment // empty' | head -1)
                    if [ -n "$COMMENT" ]; then
                      {
                        echo 'message<<EOF'
                        echo "üö´ Release was rejected: $COMMENT"
                        echo 'EOF'
                      } >> "$GITHUB_OUTPUT"
                    else
                      echo "message=üö´ Release was rejected." >> "$GITHUB_OUTPUT"
                    fi
                  else
                    echo "was_rejected=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Notify Slack - Rejected
              if: steps.check-rejection.outputs.was_rejected == 'true'
              continue-on-error: true
              uses: PostHog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: '${{ steps.check-rejection.outputs.message }}'
                  emoji_reaction: 'no_entry_sign'

    publish:
        name: Publish packages
        needs: [version-bump, notify-approval-needed]
        runs-on: ubuntu-latest
        if: always() && needs.version-bump.outputs.committed == 'true'
        permissions:
            contents: write
            actions: write
        env:
            SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
            SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
            GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
            GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        strategy:
            fail-fast: false
            # Order matters: posthog (core) must be released before posthog-android and posthog-server
            # since they are transitive dependencies. We use max-parallel: 1 to enforce sequential execution.
            max-parallel: 1
            matrix:
                package:
                    - name: posthog
                      tag_prefix: core
                      make_dry_target: dryReleaseCore
                      make_release_target: releaseCore
                      changelog: posthog/CHANGELOG.md
                    - name: posthog-android
                      tag_prefix: android
                      make_dry_target: dryReleaseAndroid
                      make_release_target: releaseAndroid
                      changelog: posthog-android/CHANGELOG.md
                    - name: posthog-server
                      tag_prefix: server
                      make_dry_target: dryReleaseServer
                      make_release_target: releaseServer
                      changelog: posthog-server/CHANGELOG.md
                    - name: posthog-android-gradle-plugin
                      tag_prefix: androidPlugin
                      make_dry_target: dryReleaseAndroidPlugin
                      make_release_target: releaseAndroidPlugin
                      changelog: posthog-android-gradle-plugin/CHANGELOG.md

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: 'Set up Java 17'
              uses: actions/setup-java@v5
              with:
                  java-version: '17'
                  distribution: 'temurin'

            - name: Setup environment
              uses: ./.github/actions/setup
              with:
                  install: false

            - name: Detect version change for ${{ matrix.package.name }}
              id: detect-version
              run: |
                  # Get the current version from gradle properties
                  CURRENT_VERSION=$(grep "^VERSION_NAME=" ${{ matrix.package.name }}/gradle.properties 2>/dev/null | cut -d'=' -f2 || echo "")
                  if [ -z "$CURRENT_VERSION" ]; then
                    echo "Could not determine current version for ${{ matrix.package.name }}"
                    echo "has-new-version=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  TAG="${{ matrix.package.tag_prefix }}-v${CURRENT_VERSION}"

                  # Check if this tag already exists
                  if git rev-parse "$TAG" >/dev/null 2>&1; then
                    echo "Tag $TAG already exists - no new version to release"
                    echo "has-new-version=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "Tag $TAG does not exist - new version detected: $CURRENT_VERSION"
                    echo "has-new-version=true" >> "$GITHUB_OUTPUT"
                    echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
                    echo "tag=$TAG" >> "$GITHUB_OUTPUT"
                  fi

            - name: Dry release ${{ matrix.package.name }}
              if: steps.detect-version.outputs.has-new-version == 'true'
              run: make ${{ matrix.package.make_dry_target }}

            - name: Release ${{ matrix.package.name }}
              if: steps.detect-version.outputs.has-new-version == 'true'
              run: make ${{ matrix.package.make_release_target }}

            - name: Tag and push ${{ matrix.package.name }}
              if: steps.detect-version.outputs.has-new-version == 'true'
              run: |
                  git tag -a "${{ steps.detect-version.outputs.tag }}" -m "${{ matrix.package.name }} ${{ steps.detect-version.outputs.version }}"
                  git push origin "${{ steps.detect-version.outputs.tag }}"

            - name: Create GitHub release for ${{ matrix.package.name }}
              if: steps.detect-version.outputs.has-new-version == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Read the latest changelog entry, skipping "## Next" and the version header line
                  # e.g. given: ## Next\n\n# 3.32.1 - 2026-02-19\n\n- no user facing changes\n\n## 3.31.0 ...
                  # it extracts: - no user facing changes
                  LAST_CHANGELOG_ENTRY=$(awk -v defText="see CHANGELOG.md" '
                    /^## Next/ { next }
                    /^#+ [0-9]/ { if (found_version) exit; found_version=1; next }
                    found_version && /^## / { exit }
                    found_version { print }
                    END { if (!found_version) print defText }
                  ' ${{ matrix.package.changelog }} | sed '/[^[:space:]]/,$!d' | tac | sed '/[^[:space:]]/,$!d' | tac)
                  gh api \
                    --method POST \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    /repos/${{ github.repository }}/releases \
                    -f tag_name="${{ steps.detect-version.outputs.tag }}" \
                    -f target_commitish='main' \
                    -f name="${{ steps.detect-version.outputs.tag }}" \
                    -f body="$LAST_CHANGELOG_ENTRY" \
                    -F draft=false \
                    -F prerelease=false \
                    -F generate_release_notes=false

            - name: Send failure event to PostHog
              if: ${{ failure() }}
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: '${{ secrets.POSTHOG_PROJECT_API_KEY }}'
                  event: 'posthog-android-github-release-workflow-failure'
                  properties: >-
                      {
                        "commitSha": "${{ github.sha }}",
                        "jobStatus": "${{ job.status }}",
                        "ref": "${{ github.ref }}",
                        "packageName": "${{ matrix.package.name }}",
                        "packageVersion": "${{ steps.detect-version.outputs.version }}"
                      }

            - name: Notify Slack - Failed
              continue-on-error: true
              if: ${{ failure() && needs.notify-approval-needed.outputs.slack_ts != '' }}
              uses: PostHog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: '‚ùå Failed to release `${{ matrix.package.name }}@${{ steps.detect-version.outputs.version }}`! <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>'
                  emoji_reaction: 'x'

    notify-released:
        name: Notify Slack - Released
        needs: [notify-approval-needed, publish]
        runs-on: ubuntu-latest
        if: always() && needs.publish.result == 'success' && needs.notify-approval-needed.outputs.slack_ts != ''
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Notify Slack - Released
              continue-on-error: true
              uses: PostHog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: 'üöÄ All packages released successfully!'
                  emoji_reaction: 'rocket'
