name: release please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      core_release_created: ${{ steps.release.outputs['posthog--release_created'] }}
      android_release_created: ${{ steps.release.outputs['posthog-android--release_created'] }}
      server_release_created: ${{ steps.release.outputs['posthog-server--release_created'] }}
      plugin_release_created: ${{ steps.release.outputs['posthog-android-gradle-plugin--release_created'] }}
      core_tag: ${{ steps.release.outputs['posthog--tag_name'] }}
      android_tag: ${{ steps.release.outputs['posthog-android--tag_name'] }}
      server_tag: ${{ steps.release.outputs['posthog-server--tag_name'] }}
      plugin_tag: ${{ steps.release.outputs['posthog-android-gradle-plugin--tag_name'] }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  publish-core:
    needs: release-please
    if: needs.release-please.outputs.core_release_created == 'true'
    runs-on: ubuntu-latest
    env:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Publish Core to Maven Central
        run: make releaseCore

  publish-android:
    needs: [release-please, publish-core]
    if: |
      always() &&
      needs.release-please.outputs.android_release_created == 'true' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped')
    runs-on: ubuntu-latest
    env:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Publish Android to Maven Central
        run: make releaseAndroid

  publish-server:
    needs: [release-please, publish-core]
    if: |
      always() &&
      needs.release-please.outputs.server_release_created == 'true' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped')
    runs-on: ubuntu-latest
    env:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Publish Server to Maven Central
        run: make releaseServer

  publish-plugin:
    needs: [release-please, publish-android]
    if: |
      always() &&
      needs.release-please.outputs.plugin_release_created == 'true' &&
      (needs.publish-android.result == 'success' || needs.publish-android.result == 'skipped')
    runs-on: ubuntu-latest
    env:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Publish Android Plugin to Maven Central
        run: make releaseAndroidPlugin
